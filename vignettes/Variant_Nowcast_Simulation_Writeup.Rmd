---
title: "Variant Nowcast Scoring Simulations"
author: "Ben Rogers"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(furrr)
library(gtools) #For rdirichlet function
library(scoringRules) #For energy score
library(abind)
library(gridExtra)
```

## The Code


Simulation functions:
```{r}
score <- function(forecast_counts, observed, n){
  
  es_sample(observed, forecast_counts)
  
}

# dirichlet_scale controls the width of the forecaster's submission
# n_theta_draws is the number of draws from the posterior forecaster submits
# n is number of observed sequences
# multi_draws is the number of draws from each multinomial distribution.

do_one_replicate <- function(replicate_index,
                             n = 500,
                             multi_draws = 50,
                             theta = c(.1, .3, .6),
                             theta_1 = c(.1, .3, .6),
                             theta_2 = c(.2, .25, .55),
                             dirichlet_scale_1 = 10,
                             dirichlet_scale_2 = 10,
                             n_theta_draws_max = 2000){
  
  
  #Sequence of possible requirements for number of draws - we will look at each one
  draw_sizes <- seq(100, n_theta_draws_max, by=100) 
  
  # Sample a draw from a multinomial(n, theta) distribution
  observed <- c(rmultinom(1, n, theta))
  
  # Group 1 samples
  theta_hat <-  t(rdirichlet(n = n_theta_draws_max, alpha = dirichlet_scale_1 * theta_1))
  
  # For each dirichlet draw, sample multi_draws multinomial counts
  # Returns K by multi_draws*n_theta_draws_max matrix, where each column is the multiple draws for each theta
  samples <- matrix(c(apply(theta_hat, 2, rmultinom, n=multi_draws, size = n)), nrow=nrow(theta_hat), byrow=F)
  
  
  #We take the first S samples from the full theta_hat and score on those
  ES_1 <- purrr::map_dbl(
    draw_sizes,
    function(one_size) {
      score(samples[,1:(one_size*multi_draws)], observed, n)
    })
  
  # Do the same as above for the group 2, who gets it wrong
  theta_hat <-  t(rdirichlet(n = n_theta_draws_max, alpha = dirichlet_scale_2 * theta_2))
  
  samples <- matrix(c(apply(theta_hat, 2, rmultinom, n=multi_draws, size = n)), nrow=nrow(theta_hat), byrow=F)
  
  ES_2 <- purrr::map_dbl(
    draw_sizes,
    function(one_size) {
      score(samples[,1:(one_size*multi_draws)], observed, n)
    })
  
  results_df = data.frame(draw_sizes, ES_1, ES_2)
  
  
  
  return(results_df)
}



#Run and plot the simulation
run_plot_simulation <- function(n, multi_draws, theta, theta_1, theta_2, dirichlet_scale_1, dirichlet_scale_2, n_theta_draws_max, seed, n_replicates)
{
  
  
  #For testing purposes
  # n <- 100
  # multi_draws <- 100
  # theta <- c(.1, .2, .3, .4)
  # wrong_theta <- c(.25, .25, .25, .25)
  # dirichlet_scale <- 10
  # n_theta_draws_max <- 1000
  # seed <- 42
  
  plan(multisession, workers = 6)
  
  
  results <- furrr::future_map(
    seq_len(n_replicates),
    do_one_replicate,
    n = n,
    multi_draws = multi_draws,
    theta = theta,
    theta_1 = theta_1,
    theta_2 = theta_2,
    dirichlet_scale_1 = dirichlet_scale_1,
    dirichlet_scale_2 = dirichlet_scale_2,
    n_theta_draws_max = n_theta_draws_max,
    .progress = TRUE,
    .options = furrr_options(seed = seed)
  )
  
  results_df <- do.call(rbind, results)
  
  results_df$rep <- rep(1:n_replicates, each=n_theta_draws_max/100)
  
  
  return(results_df)
}
```

## Scenario 1

Two Dirichlet's centered at the truth, one more certain

```{r scenario1_draws1, cache=TRUE}

sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.1,.2,.3,.4),
                             theta_2 = c(.1,.2,.3,.4),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)


```



```{r, echo=FALSE}

saveRDS(sim_1, "n100_multidraws1_scenario1.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws1_scenario1.jpg", meanplots, width = 20, height = 30, units = "cm")

```

### 10 draws from each sample proportion

```{r scenario1_draws10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 10,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.1,.2,.3,.4),
                             theta_2 = c(.1,.2,.3,.4),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}
saveRDS(sim_1, "n100_multidraws10_scenario1.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario1.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 2

Two Dirichlet's centered at some wrong value, one more certain than the other.

```{r scenario2_draws1, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.2,.2,.3,.3),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```

```{r, echo=FALSE}
end_time <- Sys.time()

end_time - start_time

saveRDS(sim_1, "n100_multidraws1_scenario2.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws1_scenario2.jpg", meanplots, width = 20, height = 30, units = "cm")

```

#### 10 draws from each sample proportion

```{r scenario2_draws10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 10,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.2,.2,.3,.3),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```

```{r, echo=FALSE}
end_time <- Sys.time()

end_time - start_time

saveRDS(sim_1, "n100_multidraws10_scenario2.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario2.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 3

Two Dirichlet's of equal certainty, closer to and farther from the truth

```{r scenario3_draws1, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.25,.25,.25,.25),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```

```{r echo=FALSE}
end_time <- Sys.time()

end_time - start_time

saveRDS(sim_1, "n100_multidraws1_scenario3.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws1_scenario3.jpg", meanplots, width = 20, height = 30, units = "cm")

```

#### 10 draws from each sample proportion

```{r scenario3_draws10, cache=TRUE}

sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 10,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.25,.25,.25,.25),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```


```{r echo=FALSE}

saveRDS(sim_1, "n100_multidraws10_scenario3.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario3.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 4: 10 Variants

First sample vector:

10 variants, first three proportions are .4, .3, .1, remaining 7 given prob .2 / 7 = 0.02857143 each.

Wrong group incorrectly has a 4th high prevalence variant: c(.4, .3, .1, .19, rep(.01/6, 6)),

```{r scenario4_draws1, cache=TRUE}

sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.4, .3, .1, .19, rep(.01/6, 6)),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```


```{r echo=FALSE}

saveRDS(sim_1, "n100_multidraws1_scenario3.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws1_scenario4.jpg", meanplots, width = 20, height = 30, units = "cm")

```

#### 10 draws from each sample proportion

```{r scenario4_draws10, cache=TRUE}

sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 10,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.4, .3, .1, .19, rep(.01/6, 6)),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```


```{r echo=FALSE}

saveRDS(sim_1, "n100_multidraws10_scenario4.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario4.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 5

10 variants, both groups get proportions correct, but group 2 has wider forecast distribution.

```{r scenario5_draws1, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.4, .3, .1, rep(.2/7 , 7)),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo= FALSE}
saveRDS(sim_1, "n100_multidraws1_scenario5.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario4.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 6

10 variant forecast, same scale parameters, group 2 misses on location.

```{r scenario6_draws1_n100, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 100, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.3, .2, .3, rep(.2/7 , 7)),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r echo=FALSE}

saveRDS(sim_1, "n100_multidraws1_scenario6.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario6.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Now everything with 10 observed samples instead of 100

## Scenario 1

Two Dirichlet's centered at the truth, one more certain

```{r scenario1_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.1,.2,.3,.4),
                             theta_2 = c(.1,.2,.3,.4),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}

saveRDS(sim_1, "n10_multidraws1_scenario1.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n10_multidraws1_scenario1.jpg", meanplots, width = 20, height = 30, units = "cm")

```

### 10 draws from each sample proportion

```{r scenario1_draws10_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 10,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.1,.2,.3,.4),
                             theta_2 = c(.1,.2,.3,.4),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```

```{r, echo=FALSE}

saveRDS(sim_1, "n10_multidraws10_scenario1.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario1.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 2

Two Dirichlet's centered at some wrong value, one more certain than the other.

```{r scenario2_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.2,.2,.3,.3),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}

saveRDS(sim_1, "n10_multidraws1_scenario2.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n10_multidraws1_scenario2.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 3

Two Dirichlet's of equal certainty, closer to and farther from the truth

```{r scenario3_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.1, .2, .3, .4),
                             theta_1 = c(.2,.2,.3,.3),
                             theta_2 = c(.25,.25,.25,.25),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}

saveRDS(sim_1, "n10_multidraws1_scenario3.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n10_multidraws1_scenario3.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## 10 Variant Question

First sample vector:

10 variants, first three probs are .4 .3 .1, remaining 7 given prob .2 / 7 = 0.02857143 each.

```{r scenario4_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.4, .3, .1, .19, rep(.01/6, 6)),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}

saveRDS(sim_1, "n10_multidraws1_scenario3.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n10_multidraws1_scenario4.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 5

```{r scenario5_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.4, .3, .1, rep(.2/7 , 7)),
                             dirichlet_scale_1 = 100, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)
```

```{r, echo=FALSE}

saveRDS(sim_1, "n100_multidraws1_scenario5_n10.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n10_multidraws10_scenario5.jpg", meanplots, width = 20, height = 30, units = "cm")

```

## Scenario 6, n=10

```{r scenario6_draws1_n10, cache=TRUE}

start_time <- Sys.time()
sim_1 <- run_plot_simulation(n = 10, 
                             multi_draws = 1,
                             theta = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_1 = c(.4, .3, .1, rep(.2/7 , 7)),
                             theta_2 = c(.3, .2, .3, rep(.2/7 , 7)),
                             dirichlet_scale_1 = 10, 
                             dirichlet_scale_2 = 10, 
                             n_theta_draws_max = 1000,
                             seed = 23,
                             n_replicates = 200)

```

```{r, echo=FALSE}

saveRDS(sim_1, "n100_multidraws1_scenario6.rds")


results_summ <- sim_1 |> group_by(draw_sizes) |> mutate(diff = ES_1 - ES_2) |>
  summarize(min_ES1 = quantile(ES_1, .1), max_ES1 = quantile(ES_1, .9), min_ES2 = quantile(ES_2, .1), max_ES2 = quantile(ES_2, .9), mean_ES1 = mean(ES_1), mean_ES2 = mean(ES_2),
            sd_ES1 = sd(ES_1), sd_ES2 = sd(ES_2), mean_diff = mean(diff), sd_diff = sd(diff), power = mean(diff<0), median_ES1 = quantile(ES_1, .5), median_ES_2 = quantile(ES_2, .5),
            min_diff = quantile(diff, .1), max_diff = quantile(diff, .9))

```

And plot it:

```{r, echo=FALSE, out.height = "150%"}

confidence_mean_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_ES1, ymax = max_ES1, x = draw_sizes),fill = "green", alpha = .25) +
  geom_ribbon(mapping = aes(ymin = min_ES2, ymax = max_ES2, x = draw_sizes),fill = "red", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES1, color="a"), linewidth=1.3 ) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_ES2, color="b"), linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Mean Energy Score") +
  scale_color_manual(name = "Forecaster", values = c('a' = "chartreuse4", 'b'= "darkred" ), labels = c("Correct", "Incorrect")) +
  theme_bw() +
  theme(legend.position="bottom")



confidence_meandiff_plot <- ggplot(data=results_summ) +
  geom_ribbon(mapping = aes(ymin = min_diff, ymax = max_diff, x = draw_sizes),fill = "plum1", alpha = .25) +
  geom_line(mapping = aes(x = draw_sizes, y = mean_diff), color="purple", linewidth=1.3 ) +
  ylab("Mean") +
  xlab("") +
  labs(title="Energy Score Difference", subtitle = "Correct - Incorrect") +
  theme_bw() 



meanplots <- grid.arrange(confidence_mean_plot, confidence_meandiff_plot)

ggsave("meanplots_n100_multidraws10_scenario6.jpg", meanplots, width = 20, height = 30, units = "cm")

```
